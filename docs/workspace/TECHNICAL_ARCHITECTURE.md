# é«˜çº§å˜é‡ç®¡ç†åŠŸèƒ½ - æŠ€æœ¯è®¾è®¡ä¸æ¶æ„

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„è®¾è®¡ (2025-01-25æ›´æ–°)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 UI å±‚                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MainLayout (å¯¼èˆªèœå•é›†æˆ)                â”‚
â”‚ â”œâ”€â”€ AdvancedModeNavigation (æ¨¡å¼åˆ‡æ¢)   â”‚
â”‚ â”œâ”€â”€ VariableManagerModal (å˜é‡ç®¡ç†å¼¹çª—)  â”‚
â”‚ â””â”€â”€ å…¶ä»–å¯¼èˆªæŒ‰é’®                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              æµ‹è¯•é¢æ¿å±‚                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AdvancedTestPanel                       â”‚
â”‚ â”œâ”€â”€ ConversationManager                 â”‚
â”‚ â”œâ”€â”€ BasicTestMode                       â”‚
â”‚ â””â”€â”€ AdvancedModeToggle (å·²ç§»é™¤)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                æœåŠ¡å±‚                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ VariableManager (UIæœåŠ¡)                â”‚
â”‚ â”œâ”€â”€ è‡ªå®šä¹‰å˜é‡ CRUD                      â”‚
â”‚ â”œâ”€â”€ é¢„å®šä¹‰å˜é‡é›†æˆ                       â”‚
â”‚ â””â”€â”€ å˜é‡è§£æå’ŒéªŒè¯                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                æ ¸å¿ƒå±‚                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PromptService (æ‰©å±•)                    â”‚
â”‚ â”œâ”€â”€ testCustomConversationStream       â”‚
â”‚ â””â”€â”€ OptimizationRequest æ‰©å±•            â”‚
â”‚                                         â”‚
â”‚ TemplateProcessor (å¤ç”¨)                â”‚
â”‚ â”œâ”€â”€ CSPå®‰å…¨å˜é‡æ›¿æ¢                      â”‚
â”‚ â””â”€â”€ ç»Ÿä¸€å˜é‡å¤„ç†é€»è¾‘                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®¾è®¡åŸåˆ™
1. **æœ€å°ä¾µå…¥**: åŸºäºç°æœ‰æ¶æ„è¿›è¡Œæœ€å°åŒ–æ‰©å±•
2. **èŒè´£åˆ†ç¦»**: UIå±‚ç®¡ç†å˜é‡ï¼ŒCoreå±‚å¤„ç†é€»è¾‘
3. **æ•°æ®ç»Ÿä¸€**: ä½¿ç”¨ç»Ÿä¸€çš„ConversationMessageç»“æ„
4. **å‘åå…¼å®¹**: æ‰€æœ‰æ–°åŠŸèƒ½éƒ½æ˜¯å¯é€‰çš„
5. **æ¸è¿›å¼å‘ç°**: é€šè¿‡å¯¼èˆªèœå•é›†æˆå®ç°åŠŸèƒ½çš„æ¸è¿›å¼å‘ç° (2025-01-25æ–°å¢)

## ğŸ“Š æ ¸å¿ƒæ¥å£è®¾è®¡

### 1. æ•°æ®ç»“æ„å®šä¹‰

```typescript
// ç»Ÿä¸€çš„æ¶ˆæ¯ç»“æ„ - æ”¯æŒä¼˜åŒ–å’Œæµ‹è¯•ä¸¤ç§åœºæ™¯
export interface ConversationMessage {
  role: 'system' | 'user' | 'assistant';
  content: string;  // æ”¯æŒå˜é‡è¯­æ³• {{variableName}}
}

// æ‰©å±•çš„ä¼˜åŒ–è¯·æ±‚æ¥å£ - ä¿æŒå‘åå…¼å®¹
export interface OptimizationRequest {
  optimizationMode: OptimizationMode;
  targetPrompt: string;
  templateId?: string;
  modelKey: string;
  // æ–°å¢ï¼šé«˜çº§æ¨¡å¼ä¸Šä¸‹æ–‡ï¼ˆå¯é€‰ï¼‰
  advancedContext?: {
    variables?: Record<string, string>;     // è‡ªå®šä¹‰å˜é‡
    messages?: ConversationMessage[];       // è‡ªå®šä¹‰ä¼šè¯æ¶ˆæ¯
  };
}

// è‡ªå®šä¹‰ä¼šè¯æµ‹è¯•è¯·æ±‚
export interface CustomConversationRequest {
  modelKey: string;
  messages: ConversationMessage[];          // ä½¿ç”¨ç›¸åŒçš„æ¶ˆæ¯ç»“æ„
  variables: Record<string, string>;       // åŒ…å«é¢„å®šä¹‰+è‡ªå®šä¹‰å˜é‡
}
```

### 2. æœåŠ¡æ¥å£æ‰©å±•

```typescript
// UIå±‚å˜é‡ç®¡ç†æœåŠ¡
export interface IVariableManager {
  // å˜é‡CRUDæ“ä½œ
  setVariable(name: string, value: string): void;
  getVariable(name: string): string | undefined;
  deleteVariable(name: string): void;
  listVariables(): Record<string, string>;
  
  // å˜é‡è§£æå’ŒéªŒè¯
  resolveAllVariables(context: TemplateContext): Record<string, string>;
  validateVariableName(name: string): boolean;
  scanVariablesInContent(content: string): string[];
}

// æ‰©å±•çš„æç¤ºè¯æœåŠ¡
export interface IPromptService {
  // ... ç°æœ‰æ–¹æ³•ä¿æŒä¸å˜
  
  // æ–°å¢ï¼šè‡ªå®šä¹‰ä¼šè¯æµ‹è¯•æ–¹æ³•
  testCustomConversationStream(
    request: CustomConversationRequest, 
    callbacks: StreamHandlers
  ): Promise<void>;
}
```

## ğŸ¨ UIç»„ä»¶æ¶æ„

### ä¸»è¦ç»„ä»¶è®¾è®¡

#### 1. AdvancedTestPanel (ä¸»ç»„ä»¶) - 2025-01-25æ›´æ–°
```vue
<template>
  <div class="advanced-test-panel">
    <!-- åŸºç¡€æ¨¡å¼ - å§‹ç»ˆæ˜¾ç¤ºåŸºç¡€æµ‹è¯•åŠŸèƒ½ -->
    <BasicTestMode 
      :prompt-service="promptService"
      :advanced-mode-enabled="advancedModeEnabled"
    />
    
    <!-- é«˜çº§æ¨¡å¼å†…å®¹ - ä»…åœ¨é«˜çº§æ¨¡å¼ä¸‹æ˜¾ç¤º -->
    <div v-if="advancedModeEnabled" class="advanced-mode-content">
      <!-- ä¼šè¯ç®¡ç†åŒºåŸŸ -->
      <ConversationManager 
        v-model:messages="conversationMessages"
        :all-variables="allVariables"
      />
      
      <!-- æµ‹è¯•æ§åˆ¶åŒºåŸŸ -->
      <TestControls
        :model-key="modelKey"
        :is-testing="isTesting"
        @start-test="handleStartTest"
      />
    </div>
  </div>
</template>
```

#### 2. MainLayout (å¯¼èˆªèœå•é›†æˆ) - 2025-01-25æ–°å¢
```vue
<template>
  <div class="main-layout">
    <!-- å¯¼èˆªèœå•åŒºåŸŸ -->
    <div class="navigation-actions">
      <!-- é«˜çº§æ¨¡å¼å¯¼èˆªæŒ‰é’® - å§‹ç»ˆæ˜¾ç¤º -->
      <ActionButtonUI
        icon="ğŸš€"
        :text="$t('nav.advancedMode')"
        @click="toggleAdvancedMode"
        :class="{ 'active-button': advancedModeEnabled }"
      />
      
      <!-- å˜é‡ç®¡ç†æŒ‰é’® - ä»…åœ¨é«˜çº§æ¨¡å¼ä¸‹æ˜¾ç¤º -->
      <ActionButtonUI
        v-if="advancedModeEnabled"
        icon="ğŸ“Š"
        :text="$t('nav.variableManager')"
        @click="showVariableManager = true"
      />
      
      <!-- å…¶ä»–å¯¼èˆªæŒ‰é’®... -->
    </div>
    
    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <div class="main-content">
      <AdvancedTestPanel 
        :advanced-mode-enabled="advancedModeEnabled"
        :services="services"
      />
    </div>
    
    <!-- å˜é‡ç®¡ç†å¼¹çª— -->
    <VariableManagerModal
      v-if="showVariableManager"
      v-model:visible="showVariableManager"
      :variable-manager="variableManager"
    />
  </div>
</template>
```

#### 3. VariableManagerModal (å˜é‡ç®¡ç†å¼¹çª—ç»„ä»¶) - 2025-01-25æ›´æ–°
```vue
<template>
  <div class="variable-manager">
    <div class="variable-header">
      <h3>{{ t('variables.title') }}</h3>
      <div class="variable-stats">
        {{ t('variables.stats', { total: totalVariables, custom: customVariables.length }) }}
      </div>
    </div>
    
    <!-- å˜é‡åˆ—è¡¨ -->
    <div class="variable-list">
      <VariableItem
        v-for="(value, name) in allVariables"
        :key="name"
        :name="name"
        :value="value"
        :is-predefined="isPredefinedVariable(name)"
        @update="updateVariable"
        @delete="deleteVariable"
      />
    </div>
    
    <!-- æ·»åŠ å˜é‡ -->
    <AddVariableForm @add="addVariable" />
  </div>
</template>
```

#### 4. ConversationManager (ä¼šè¯ç®¡ç†ç»„ä»¶)
```vue
<template>
  <div class="conversation-manager">
    <div class="conversation-header">
      <h3>{{ t('conversation.title') }}</h3>
      <div class="conversation-stats">
        {{ t('conversation.stats', { count: messages.length }) }}
      </div>
    </div>
    
    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
    <div class="message-list">
      <ConversationMessageEditor
        v-for="(message, index) in messages"
        :key="index"
        :message="message"
        :variables="allVariables"
        :missing-variables="getMissingVariables(message.content)"
        @update="updateMessage(index, $event)"
        @delete="deleteMessage(index)"
        @move-up="moveMessage(index, -1)"
        @move-down="moveMessage(index, 1)"
      />
    </div>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <div class="conversation-actions">
      <button @click="addMessage">{{ t('conversation.addMessage') }}</button>
      <QuickTemplateSelector @select="applyTemplate" />
      <button @click="showPreview = !showPreview">
        {{ t('conversation.togglePreview') }}
      </button>
    </div>
    
    <!-- é¢„è§ˆé¢æ¿ -->
    <MessagePreview 
      v-if="showPreview"
      :messages="messages"
      :variables="allVariables"
    />
  </div>
</template>
```

## âš™ï¸ æ ¸å¿ƒå®ç°é€»è¾‘

### 1. å˜é‡ç®¡ç†å®ç°

```typescript
// packages/ui/src/services/VariableManager.ts
export class VariableManager implements IVariableManager {
  private customVariables: Record<string, string> = {};
  private readonly predefinedVariables = [
    'originalPrompt', 
    'lastOptimizedPrompt', 
    'iterateInput'
  ];
  
  constructor(private preferenceService: IPreferenceService) {
    this.loadCustomVariables();
  }
  
  // å˜é‡CRUDæ“ä½œ
  setVariable(name: string, value: string): void {
    if (!this.validateVariableName(name)) {
      throw new Error(`Invalid variable name: ${name}`);
    }
    
    this.customVariables[name] = value;
    this.saveCustomVariables();
  }
  
  deleteVariable(name: string): void {
    if (this.predefinedVariables.includes(name)) {
      throw new Error('Cannot delete predefined variable');
    }
    
    delete this.customVariables[name];
    this.saveCustomVariables();
  }
  
  // è§£ææ‰€æœ‰å˜é‡ï¼ˆé¢„å®šä¹‰ + è‡ªå®šä¹‰ï¼‰
  resolveAllVariables(context: TemplateContext): Record<string, string> {
    const predefinedVars = this.extractPredefinedVariables(context);
    return { ...predefinedVars, ...this.customVariables };
  }
  
  // æ‰«æå†…å®¹ä¸­çš„å˜é‡å¼•ç”¨
  scanVariablesInContent(content: string): string[] {
    const regex = /\{\{(\w+)\}\}/g;
    const variables: string[] = [];
    let match;
    
    while ((match = regex.exec(content)) !== null) {
      variables.push(match[1]);
    }
    
    return [...new Set(variables)];
  }
  
  // å˜é‡åéªŒè¯
  validateVariableName(name: string): boolean {
    return /^[a-zA-Z_][a-zA-Z0-9_]*$/.test(name);
  }
}
```

### 2. ä¼šè¯ç®¡ç†å®ç°

```typescript
// packages/ui/src/composables/useConversationManager.ts
export function useConversationManager() {
  const messages = ref<ConversationMessage[]>([]);
  const variableManager = inject<VariableManager>('variableManager')!;
  
  // æ·»åŠ æ¶ˆæ¯
  const addMessage = (role: 'system' | 'user' | 'assistant' = 'user') => {
    messages.value.push({
      role,
      content: ''
    });
  };
  
  // æ›´æ–°æ¶ˆæ¯
  const updateMessage = (index: number, message: ConversationMessage) => {
    if (index >= 0 && index < messages.value.length) {
      messages.value[index] = { ...message };
    }
  };
  
  // åˆ é™¤æ¶ˆæ¯
  const deleteMessage = (index: number) => {
    if (index >= 0 && index < messages.value.length) {
      messages.value.splice(index, 1);
    }
  };
  
  // æ£€æµ‹ç¼ºå¤±å˜é‡
  const getMissingVariables = (content: string): string[] => {
    const referencedVars = variableManager.scanVariablesInContent(content);
    const availableVars = Object.keys(variableManager.listVariables());
    
    return referencedVars.filter(variable => !availableVars.includes(variable));
  };
  
  // é¢„è§ˆæ¶ˆæ¯ï¼ˆå˜é‡æ›¿æ¢åï¼‰
  const previewMessages = (variables: Record<string, string>): ConversationMessage[] => {
    return messages.value.map(message => ({
      ...message,
      content: replaceVariables(message.content, variables)
    }));
  };
  
  return {
    messages,
    addMessage,
    updateMessage,
    deleteMessage,
    getMissingVariables,
    previewMessages
  };
}
```

### 3. æµ‹è¯•æµç¨‹å®ç°

```typescript
// packages/core/src/services/prompt/service.ts (æ‰©å±•)
export class PromptService implements IPromptService {
  // ... ç°æœ‰æ–¹æ³•ä¿æŒä¸å˜
  
  // æ–°å¢ï¼šè‡ªå®šä¹‰ä¼šè¯æµå¼æµ‹è¯•
  async testCustomConversationStream(
    request: CustomConversationRequest,
    callbacks: StreamHandlers
  ): Promise<void> {
    try {
      // 1. éªŒè¯è¯·æ±‚
      this.validateCustomConversationRequest(request);
      
      // 2. è§£æå˜é‡
      const processedMessages = this.processMessagesVariables(
        request.messages,
        request.variables
      );
      
      // 3. è§„èŒƒåŒ–è§’è‰²
      const normalizedMessages = this.normalizeMessageRoles(processedMessages);
      
      // 4. è°ƒç”¨LLMæœåŠ¡
      await this.llmService.streamChatCompletion({
        modelKey: request.modelKey,
        messages: normalizedMessages,
        onProgress: callbacks.onProgress,
        onComplete: callbacks.onComplete,
        onError: callbacks.onError
      });
      
    } catch (error) {
      callbacks.onError?.(error as Error);
    }
  }
  
  // å¤„ç†æ¶ˆæ¯ä¸­çš„å˜é‡
  private processMessagesVariables(
    messages: ConversationMessage[],
    variables: Record<string, string>
  ): ConversationMessage[] {
    return messages.map(message => ({
      ...message,
      content: this.templateProcessor.replaceVariables(message.content, variables)
    }));
  }
  
  // è§„èŒƒåŒ–æ¶ˆæ¯è§’è‰² (ai -> assistant)
  private normalizeMessageRoles(
    messages: ConversationMessage[]
  ): ConversationMessage[] {
    return messages.map(message => ({
      ...message,
      role: message.role === 'ai' ? 'assistant' : message.role
    })) as ConversationMessage[];
  }
}
```

## ğŸ”§ å…³é”®æŠ€æœ¯å†³ç­–

### 1. æ¥å£æ‰©å±•ç­–ç•¥
**å†³ç­–**: ä½¿ç”¨å¯é€‰å­—æ®µæ‰©å±•ç°æœ‰æ¥å£
```typescript
// æ‰©å±•è€Œéé‡å†™
interface OptimizationRequest {
  // ... ç°æœ‰å­—æ®µä¿æŒä¸å˜
  advancedContext?: {  // å¯é€‰å­—æ®µï¼Œä¿æŒå‘åå…¼å®¹
    variables?: Record<string, string>;
    messages?: ConversationMessage[];
  };
}
```
**ä¼˜åŠ¿**: ä¿æŒå‘åå…¼å®¹ï¼Œç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹

### 2. å˜é‡ç®¡ç†ä½ç½®
**å†³ç­–**: UIå±‚ç®¡ç†è‡ªå®šä¹‰å˜é‡ï¼ŒCoreå±‚å¤„ç†é¢„å®šä¹‰å˜é‡
**ç†ç”±**: 
- é¿å…åç«¯å¤æ‚åº¦
- ç”¨æˆ·è‡ªå®šä¹‰å˜é‡æœ¬è´¨ä¸Šæ˜¯å‰ç«¯é…ç½®
- ä¿æŒCoreå±‚çš„çº¯å‡€æ€§

### 3. æ¶ˆæ¯ç»“æ„ç»Ÿä¸€
**å†³ç­–**: ä¼˜åŒ–å’Œæµ‹è¯•é˜¶æ®µä½¿ç”¨ç›¸åŒçš„ConversationMessageç»“æ„
**ä¼˜åŠ¿**: 
- å‡å°‘ç±»å‹å¤æ‚åº¦
- ç»„ä»¶å¯å¤ç”¨
- ç”¨æˆ·ç†è§£ä¸€è‡´

### 4. CSPå®‰å…¨ä¿è¯
**å†³ç­–**: å¤ç”¨ç°æœ‰CSPSafeTemplateProcessor
**å®ç°**: 
```typescript
// å¤ç”¨ç°æœ‰å®‰å…¨æœºåˆ¶
const processedContent = this.templateProcessor.replaceVariables(
  message.content, 
  variables
);
```

### 5. å¯¼èˆªèœå•é›†æˆç­–ç•¥ (2025-01-25æ–°å¢)
**å†³ç­–**: å°†é«˜çº§æ¨¡å¼åˆ‡æ¢é›†æˆåˆ°å¯¼èˆªèœå•ï¼Œå˜é‡ç®¡ç†æ”¹ä¸ºç‹¬ç«‹å¼¹çª—
**å®ç°**: 
```typescript
// å¯¼èˆªèœå•çŠ¶æ€ç®¡ç†
const advancedModeEnabled = ref(false)
const showVariableManager = ref(false)

// äº¤äº’é€»è¾‘
const toggleAdvancedMode = () => {
  advancedModeEnabled.value = !advancedModeEnabled.value
}

const openVariableManager = () => {
  showVariableManager.value = true
}
```
**ä¼˜åŠ¿**: 
- åŸºç¡€æ¨¡å¼ä¸‹ç•Œé¢å‡ ä¹ä¸å˜
- æ¸è¿›å¼åŠŸèƒ½å‘ç°
- ç‹¬ç«‹çš„å˜é‡ç®¡ç†ç•Œé¢

### 6. å˜é‡çŠ¶æ€åŒæ­¥ç­–ç•¥ (2025-08-26æ–°å¢)
**å†³ç­–**: ä½¿ç”¨ç»Ÿä¸€çš„å˜é‡ç®¡ç†å™¨å®ä¾‹ï¼Œé¿å…å¤šå®ä¾‹å¯¼è‡´çš„æ•°æ®ä¸åŒæ­¥
**é—®é¢˜**: AdvancedTestPanel åˆ›å»ºç‹¬ç«‹çš„å˜é‡ç®¡ç†å™¨å®ä¾‹ï¼Œå¯¼è‡´ä¸ä¸»åº”ç”¨å®ä¾‹æ•°æ®ä¸åŒæ­¥
**è§£å†³æ–¹æ¡ˆ**: 
```typescript
// åœ¨AdvancedTestPanelä¸­ä¼˜å…ˆä½¿ç”¨ä¼ å…¥çš„å˜é‡ç®¡ç†å™¨å®ä¾‹
const variableManager: Ref<VariableManagerHooks | null> = computed(() => {
  if (props.variableManager) {
    return props.variableManager  // ä½¿ç”¨App.vueä¼ å…¥çš„ç»Ÿä¸€å®ä¾‹
  }
  return localVariableManager      // åå¤‡æ–¹æ¡ˆï¼šæœ¬åœ°å®ä¾‹
})
```
**æŠ€æœ¯å®ç°**:
- App.vue å°†å…¶å˜é‡ç®¡ç†å™¨å®ä¾‹ä¼ é€’ç»™æ‰€æœ‰å­ç»„ä»¶
- æ‰€æœ‰ç»„ä»¶ä½¿ç”¨ç›¸åŒçš„å˜é‡ç®¡ç†å™¨å®ä¾‹
- ç¡®ä¿å˜é‡æ•°æ®çš„å®æ—¶åŒæ­¥å’Œä¸€è‡´æ€§

### 7. ä¸»é¢˜CSSé›†æˆç­–ç•¥ (2025-08-26æ–°å¢)
**å†³ç­–**: ç»Ÿä¸€ä½¿ç”¨é¡¹ç›®çš„ä¸»é¢˜CSSç³»ç»Ÿï¼Œé¿å…ç¡¬ç¼–ç æ ·å¼
**å®ç°**:
```typescript
// ä½¿ç”¨ä¸»é¢˜ç®¡ç†å™¨ç±»æ›¿æ¢ç¡¬ç¼–ç æ ·å¼
<div class="add-message-row theme-manager-card">
  <button class="add-message-btn theme-manager-button-secondary">
    æ·»åŠ æ¶ˆæ¯
  </button>
</div>
```
**ä¼˜åŠ¿**:
- ä¿æŒUIé£æ ¼ä¸€è‡´æ€§
- æ”¯æŒä¸»é¢˜åˆ‡æ¢
- å‡å°‘ç»´æŠ¤æˆæœ¬

### 8. è®¾ç½®æŒä¹…åŒ–ç­–ç•¥ (2025-08-26æ–°å¢)
**å†³ç­–**: ä½¿ç”¨é¡¹ç›®ç»Ÿä¸€çš„ preferenceService è¿›è¡Œè®¾ç½®æŒä¹…åŒ–
**å®ç°**:
```typescript
// é«˜çº§æ¨¡å¼çŠ¶æ€æŒä¹…åŒ–
const loadAdvancedModeSetting = async () => {
  if (services.value?.preferenceService) {
    const saved = await services.value.preferenceService.get('advancedModeEnabled', false)
    advancedModeEnabled.value = saved
  }
}

const saveAdvancedModeSetting = async (enabled: boolean) => {
  if (services.value?.preferenceService) {
    await services.value.preferenceService.set('advancedModeEnabled', enabled)
  }
}
```
**ä¼˜åŠ¿**:
- ç”¨æˆ·è®¾ç½®åœ¨é‡å¯åä¿æŒ
- ä½¿ç”¨ç»Ÿä¸€çš„å­˜å‚¨æœºåˆ¶
- æ”¯æŒè·¨å¹³å°æ•°æ®åŒæ­¥

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•è¦†ç›–
```typescript
// å˜é‡ç®¡ç†å™¨æµ‹è¯•
describe('VariableManager', () => {
  it('should handle custom variables CRUD', () => {
    // æµ‹è¯•è‡ªå®šä¹‰å˜é‡çš„å¢åˆ æ”¹æŸ¥
  });
  
  it('should integrate with predefined variables', () => {
    // æµ‹è¯•ä¸é¢„å®šä¹‰å˜é‡çš„é›†æˆ
  });
  
  it('should validate variable names', () => {
    // æµ‹è¯•å˜é‡åéªŒè¯é€»è¾‘
  });
});

// ä¼šè¯ç®¡ç†æµ‹è¯•
describe('ConversationManager', () => {
  it('should detect missing variables', () => {
    // æµ‹è¯•ç¼ºå¤±å˜é‡æ£€æµ‹
  });
  
  it('should preview variable replacement', () => {
    // æµ‹è¯•å˜é‡æ›¿æ¢é¢„è§ˆ
  });
});
```

### é›†æˆæµ‹è¯•éªŒè¯
- å®Œæ•´çš„å˜é‡ç®¡ç†æµç¨‹æµ‹è¯•
- ä¼šè¯ç¼–è¾‘åˆ°æµ‹è¯•çš„ç«¯åˆ°ç«¯æµç¨‹
- ä¸åŒæ¨¡å¼ä¹‹é—´çš„åˆ‡æ¢æµ‹è¯•
- é”™è¯¯å¤„ç†å’Œæ¢å¤æµ‹è¯•

## ğŸ“ˆ æ€§èƒ½è€ƒè™‘

### ä¼˜åŒ–ç‚¹
1. **å˜é‡æ‰«æç¼“å­˜**: é¿å…é‡å¤çš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
2. **ç»„ä»¶æ‡’åŠ è½½**: é«˜çº§æ¨¡å¼ç»„ä»¶æŒ‰éœ€åŠ è½½
3. **çŠ¶æ€æ›´æ–°èŠ‚æµ**: é¿å…é¢‘ç¹çš„å­˜å‚¨å†™å…¥
4. **è™šæ‹Ÿæ»šåŠ¨**: å¤§é‡å˜é‡æ—¶çš„åˆ—è¡¨æ¸²æŸ“ä¼˜åŒ–

### å†…å­˜ç®¡ç†
```typescript
// ç»„ä»¶å¸è½½æ—¶æ¸…ç†ç›‘å¬å™¨
onUnmounted(() => {
  // æ¸…ç†å˜é‡ç®¡ç†å™¨çš„äº‹ä»¶ç›‘å¬
  variableManager.removeAllListeners();
  
  // æ¸…ç†ä¼šè¯ç®¡ç†å™¨çš„çŠ¶æ€
  conversationManager.cleanup();
});
```

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. å˜é‡æ³¨å…¥å®‰å…¨
- æ‰€æœ‰å˜é‡æ›¿æ¢éƒ½é€šè¿‡CSPSafeTemplateProcessorå¤„ç†
- é˜²æ­¢XSSæ”»å‡»å’Œä»£ç æ³¨å…¥
- å˜é‡åå’Œå€¼çš„ä¸¥æ ¼éªŒè¯

### 2. æ•°æ®å­˜å‚¨å®‰å…¨
- è‡ªå®šä¹‰å˜é‡å­˜å‚¨åœ¨æœ¬åœ°LocalStorage
- æ•æ„Ÿä¿¡æ¯ä¸åŒ…å«åœ¨å˜é‡ç³»ç»Ÿä¸­
- å®šæœŸæ¸…ç†æ— æ•ˆçš„å˜é‡æ•°æ®

### 9. Apply to Test åŠŸèƒ½æ¶æ„è®¾è®¡ (2025-08-27æ–°å¢)
**å†³ç­–**: å°†"åº”ç”¨åˆ°æµ‹è¯•"ä»ç®€å•é«˜çº§æ¨¡å¼å¯ç”¨è½¬å˜ä¸ºæ™ºèƒ½æµ‹è¯•é…ç½®ç³»ç»Ÿ
**é—®é¢˜èƒŒæ™¯**: 
- ç”¨æˆ·åé¦ˆåŸæœ‰åŠŸèƒ½åªæ˜¯å¯ç”¨é«˜çº§æ¨¡å¼ï¼Œç¼ºä¹å®é™…ä»·å€¼
- éœ€è¦æ ¹æ®ä¼˜åŒ–æ¨¡å¼æ™ºèƒ½åˆ›å»ºåˆé€‚çš„æµ‹è¯•ç¯å¢ƒ

**æŠ€æœ¯æ¶æ„**:
```typescript
// æ ¸å¿ƒå˜é‡ç³»ç»Ÿæ‰©å±•
export const PREDEFINED_VARIABLES = [
  'originalPrompt',
  'lastOptimizedPrompt', 
  'iterateInput',
  'currentPrompt'  // æµ‹è¯•é˜¶æ®µä½¿ç”¨çš„å½“å‰æç¤ºè¯å˜é‡
] as const;

// æ™ºèƒ½æ¨¡æ¿é…ç½®æ–¹æ³•
const applyOptimizedPromptToTest = (optimizationData: {
  originalPrompt: string
  optimizedPrompt: string
  optimizationMode: string
}) => {
  if (optimizationData.optimizationMode === 'system') {
    // ç³»ç»Ÿæç¤ºè¯ä¼˜åŒ–ï¼šç³»ç»Ÿæ¶ˆæ¯ + ç”¨æˆ·äº¤äº’æ¶ˆæ¯
    conversationMessages.value = [
      { role: 'system', content: '{{currentPrompt}}' },
      { role: 'user', content: 'è¯·æŒ‰ç…§ä½ çš„è§’è‰²è®¾å®šï¼Œå±•ç¤ºä½ çš„èƒ½åŠ›å¹¶ä¸æˆ‘äº’åŠ¨ã€‚' }
    ]
  } else {
    // ç”¨æˆ·æç¤ºè¯ä¼˜åŒ–ï¼šä»…ç”¨æˆ·æ¶ˆæ¯
    conversationMessages.value = [
      { role: 'user', content: '{{currentPrompt}}' }
    ]
  }
}

// ç»„ä»¶é€šä¿¡å®ç°
const handleApplyToTest = () => {
  // è‡ªåŠ¨å¯ç”¨é«˜çº§æ¨¡å¼
  if (!advancedModeEnabled.value) {
    advancedModeEnabled.value = true
    saveAdvancedModeSetting(true)
  }
  
  // è°ƒç”¨é«˜çº§æµ‹è¯•é¢æ¿çš„é…ç½®æ–¹æ³•
  nextTick(() => {
    advancedTestPanel.applyOptimizedPromptToTest({
      originalPrompt: optimizer.prompt,
      optimizedPrompt: optimizer.optimizedPrompt,
      optimizationMode: selectedOptimizationMode.value
    })
  })
}
```

**ä¼˜åŠ¿**: 
- æ™ºèƒ½ç”Ÿæˆæµ‹è¯•æ¨¡æ¿ï¼ŒèŠ‚çœç”¨æˆ·é…ç½®æ—¶é—´
- æ¨¡å¼æ„ŸçŸ¥é…ç½®ï¼Œæä¾›æœ€ä½³æµ‹è¯•åœºæ™¯
- ç»Ÿä¸€å˜é‡ç³»ç»Ÿï¼Œæ”¯æŒçµæ´»çš„æç¤ºè¯åˆ‡æ¢