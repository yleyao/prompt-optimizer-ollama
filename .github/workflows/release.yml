name: Release Desktop Apps

on:
  push:
    tags:
      - 'v*.*.*'        # æ­£å¼ç‰ˆæœ¬: v1.0.0, v2.1.3
      - 'v*.*.*-*'      # é¢„è§ˆç‰ˆæœ¬: v1.0.0-beta.1, v1.0.0-rc.1

env:
  NODE_VERSION: '22'
  PNPM_VERSION: '10.6.1'

jobs:
  # æž„å»º Windows ç‰ˆæœ¬
  build-windows:
    runs-on: windows-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: è®¾ç½® Node.js çŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install

      - name: æž„å»º Desktop åº”ç”¨
        run: pnpm build:desktop

      - name: ä¸Šä¼  Windows æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: packages/desktop/dist/*.exe
          retention-days: 30

  # æž„å»º macOS ç‰ˆæœ¬
  build-macos:
    runs-on: macos-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: è®¾ç½® Node.js çŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install

      - name: æž„å»º Desktop åº”ç”¨
        run: pnpm build:desktop

      - name: ä¸Šä¼  macOS æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: packages/desktop/dist/*.dmg
          retention-days: 30

  # æž„å»º Linux ç‰ˆæœ¬
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: è®¾ç½® Node.js çŽ¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install

      - name: æž„å»º Desktop åº”ç”¨
        run: pnpm build:desktop

      - name: ä¸Šä¼  Linux æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: packages/desktop/dist/*.AppImage
          retention-days: 30

  # åˆ›å»º GitHub Release
  create-release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: èŽ·å–ç‰ˆæœ¬å·å’Œç±»åž‹
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

          # åˆ¤æ–­æ˜¯å¦ä¸ºé¢„è§ˆç‰ˆæœ¬
          if [[ $VERSION == *"-"* ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "This is a prerelease version"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "This is a stable release"
          fi

      - name: ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: æ˜¾ç¤ºæž„å»ºäº§ç‰©
        run: |
          echo "æž„å»ºäº§ç‰©åˆ—è¡¨:"
          find ./artifacts -type f -name "*" | sort

      - name: ç”Ÿæˆ Release Notes
        id: release_notes
        run: |
          # èŽ·å–ä¸Šä¸€ä¸ªtag
          PREVIOUS_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -2 | tail -1)
          CURRENT_TAG=${{ steps.version.outputs.version }}

          echo "Previous tag: $PREVIOUS_TAG"
          echo "Current tag: $CURRENT_TAG"

          # ç”ŸæˆcommitåŽ†å²ï¼ˆå¤„ç†å¤šè¡Œå’Œé•¿commitï¼‰
          if [ -n "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log --pretty=format:"%s|%h" $PREVIOUS_TAG..$CURRENT_TAG | while IFS='|' read -r subject hash; do
              # æˆªæ–­è¿‡é•¿çš„commit messageï¼ˆä¿ç•™å‰80ä¸ªå­—ç¬¦ï¼‰
              if [ ${#subject} -gt 80 ]; then
                subject="${subject:0:77}..."
              fi
              echo "- $subject (\`$hash\`)"
            done)
          else
            COMMITS=$(git log --pretty=format:"%s|%h" $CURRENT_TAG | while IFS='|' read -r subject hash; do
              # æˆªæ–­è¿‡é•¿çš„commit messageï¼ˆä¿ç•™å‰80ä¸ªå­—ç¬¦ï¼‰
              if [ ${#subject} -gt 80 ]; then
                subject="${subject:0:77}..."
              fi
              echo "- $subject (\`$hash\`)"
            done)
          fi

          # æ£€æŸ¥æ˜¯å¦æœ‰commits
          if [ -z "$COMMITS" ]; then
            COMMITS="- é¦–æ¬¡å‘å¸ƒ"
          fi

          # é™åˆ¶commitsæ•°é‡ï¼ˆæœ€å¤šæ˜¾ç¤º20ä¸ªï¼‰
          COMMITS_LIMITED=$(echo "$COMMITS" | head -20)
          COMMITS_COUNT=$(echo "$COMMITS" | wc -l)

          if [ $COMMITS_COUNT -gt 20 ]; then
            COMMITS_LIMITED="$COMMITS_LIMITED

          ... ä»¥åŠå…¶ä»– $((COMMITS_COUNT - 20)) ä¸ªæäº¤"
          fi

          # åˆ›å»ºrelease notes
          cat > release_notes.md << EOF
          ## ðŸš€ Prompt Optimizer $CURRENT_TAG

          ### ðŸ“¦ ä¸‹è½½
          - **Windows**: \`Prompt Optimizer Setup *.exe\`
          - **macOS**: \`Prompt Optimizer-*.dmg\`
          - **Linux**: \`Prompt Optimizer-*.AppImage\`

          ### ðŸ”§ å®‰è£…è¯´æ˜Ž
          - **Windows**: ä¸‹è½½ \`.exe\` æ–‡ä»¶ç›´æŽ¥å®‰è£…
          - **macOS**: ä¸‹è½½ \`.dmg\` æ–‡ä»¶ï¼Œæ‹–æ‹½åˆ°åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹
          - **Linux**: ä¸‹è½½ \`.AppImage\` æ–‡ä»¶ï¼Œæ·»åŠ æ‰§è¡Œæƒé™åŽç›´æŽ¥è¿è¡Œ

          ### ðŸ“ æ›´æ–°å†…å®¹
          $COMMITS_LIMITED

          ### ðŸ”— å®Œæ•´æ›´æ–°æ—¥å¿—
          è¯·æŸ¥çœ‹ [CHANGELOG.md](./CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹ã€‚

          ---
          **æç¤º**: å¦‚æžœéœ€è¦æŸ¥çœ‹å®Œæ•´çš„æäº¤åŽ†å²ï¼Œè¯·è®¿é—® [GitHub Commits](https://github.com/\${{ github.repository }}/compare/$PREVIOUS_TAG...$CURRENT_TAG)
          EOF

          echo "Generated release notes:"
          cat release_notes.md

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.is_prerelease == 'true' && format('Preview {0}', steps.version.outputs.version) || format('Release {0}', steps.version.outputs.version) }}
          body_path: release_notes.md
          files: |
            ./artifacts/windows-build/*
            ./artifacts/macos-build/*
            ./artifacts/linux-build/*
          draft: false
          prerelease: ${{ steps.version.outputs.is_prerelease == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
